<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ç§‹æ—¥å°å†œåœº Â· å•æ–‡ä»¶åŸå‹</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX in-browser transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      html, body, #root { height: 100%; }
      body { margin: 0; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      // ä½¿ React çš„ Hooks å¯ç”¨ï¼ˆæ— éœ€ importï¼‰
      const { useEffect, useMemo, useState } = React;

/**
 * æ›´æ–°è¯´æ˜ï¼ˆ2025-10-31ï¼‰ï¼š
 * - ä½œç‰©æ‰©å……åˆ° 18 ç§ï¼Œå¹¶ä¿æŒé«˜çº§ä½œç‰©æ•ˆç›Šé€’å¢ï¼›åŒæ­¥èƒŒåŒ…ä¸å•†åº—è‡ªåŠ¨é€‚é…ï¼›
 * - æ–°å¢ã€ŒğŸ° Gluck æŠ½å¥–ã€äºŒçº§å¼¹çª—ï¼Œå¯æ¶ˆè€—å¥–åˆ¸æŠ½å–å¥–åŠ±ï¼›
 * - è§†è§‰é‡åˆ¶ï¼ˆç”°å›­Â·ç§‹è‰²ï¼‰ï¼š
 *   - èƒŒæ™¯ä¸ºåŠ¨æ€ç§‹æ™¯ï¼šå¤©ç©ºæ¸å˜ + ç¼“æ…¢ç§»åŠ¨çš„äº‘ + é£˜è½æ ‘å¶ï¼›
 *   - åœ°å—å¡ç‰‡æ¢ä¸ºæ›´çœŸå®çš„ã€Œé»„åœŸåœ°ã€è´¨æ„Ÿï¼ˆæ£•åœŸé…è‰² + ç»†å¾®é¢—ç²’çº¹ç†ï¼‰ï¼Œæ›´æŸ”å’Œçš„åœ†è§’ä¸é˜´å½±ï¼›
 * - å·¥å…·ç®±æ”¹ä¸ºä¸èƒŒåŒ…ä¸€è‡´çš„ã€Œæ ¼å­å›¾æ ‡ã€è®¾è®¡ï¼ˆæ–¹å½¢æ ¼å­ + æ‚¬æµ®æç¤ºï¼‰ï¼›
 * - å…¶ä½™ç©æ³•ä¿æŒä¸å˜ï¼ˆéœ€æµ‡æ°´ä¸€æ¬¡ã€å·¥å…·æŒ‡é’ˆã€å•†åº—ä¸‰å¸ç§ã€æµ‹è¯•é…ç½®ç­‰ï¼‰ã€‚
 */

/**********************
 * åŸºç¡€å¸¸é‡ä¸å·¥å…·å‡½æ•° *
 **********************/
const TICK_MS = 1000; // 1s åˆ·æ–°ä¸€æ¬¡

// é˜¶æ®µå­—é¢é‡
const STAGE = { EMPTY: "EMPTY", SEED: "SEED", SPROUT: "SPROUT", GROWING: "GROWING", RIPE: "RIPE", WITHER: "WITHER" };

// 18 ç§ä½œç‰©ï¼ˆæ—¶é—´å•ä½ï¼šç§’ï¼‰â€”â€”æˆæœ¬/å”®ä»·/ç»éªŒ/æ—¶é—´é€çº§é€’å¢
const SEEDS = {
  // ä½çº§ä½œç‰©ï¼šå¿«é€Ÿæˆç†Ÿï¼ˆ30ç§’-8åˆ†é’Ÿï¼‰
  radish:     { id: "radish",     name: "ç™½èåœ",  cost: 2,   sell: 5,    exp: 2,   stages: [10, 20, 30],    witherAfter: 60,   emoji: "ğŸ¥•", levelReq: 1 },      // 30ç§’æˆç†Ÿï¼Œæ¯è1åˆ†é’Ÿ
  strawberry: { id: "strawberry", name: "è‰è“",    cost: 6,   sell: 14,   exp: 5,   stages: [20, 40, 60],    witherAfter: 120,  emoji: "ğŸ“", levelReq: 2 },      // 1åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è2åˆ†é’Ÿ
  corn:       { id: "corn",       name: "ç‰ç±³",    cost: 10,  sell: 26,   exp: 9,   stages: [40, 80, 120],   witherAfter: 180,  emoji: "ğŸŒ½", levelReq: 3 },      // 2åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è3åˆ†é’Ÿ
  grape:      { id: "grape",      name: "è‘¡è„",    cost: 18,  sell: 50,   exp: 16,  stages: [80, 160, 240],  witherAfter: 300,  emoji: "ğŸ‡", levelReq: 4 },      // 4åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è5åˆ†é’Ÿ
  tomato:     { id: "tomato",     name: "ç•ªèŒ„",    cost: 22,  sell: 64,   exp: 20,  stages: [160, 320, 480], witherAfter: 480,  emoji: "ğŸ…", levelReq: 5 },      // 8åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è8åˆ†é’Ÿ
  // ä¸­çº§ä½œç‰©ï¼šä¸­ç­‰æˆç†Ÿï¼ˆ15åˆ†é’Ÿ-2å°æ—¶ï¼‰
  blueberry:  { id: "blueberry",  name: "è“è“",    cost: 30,  sell: 90,   exp: 28,  stages: [300, 600, 900],  witherAfter: 600,  emoji: "ğŸ«", levelReq: 6 },      // 15åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è10åˆ†é’Ÿ
  pumpkin:    { id: "pumpkin",    name: "å—ç“œ",    cost: 42,  sell: 128,  exp: 36,  stages: [600, 1200, 1800], witherAfter: 900,  emoji: "ğŸƒ", levelReq: 7 },      // 30åˆ†é’Ÿæˆç†Ÿï¼Œæ¯è15åˆ†é’Ÿ
  pineapple:  { id: "pineapple",  name: "è è",    cost: 58,  sell: 178,  exp: 48,  stages: [1200, 2400, 3600], witherAfter: 1200, emoji: "ğŸ", levelReq: 8 },      // 1å°æ—¶æˆç†Ÿï¼Œæ¯è20åˆ†é’Ÿ
  coffee:     { id: "coffee",     name: "å’–å•¡è±†",  cost: 80,  sell: 250,  exp: 65,  stages: [2400, 4800, 7200], witherAfter: 1800, emoji: "â˜•", levelReq: 9 },      // 2å°æ—¶æˆç†Ÿï¼Œæ¯è30åˆ†é’Ÿ
  // é«˜çº§ä½œç‰©ï¼šè¾ƒé•¿æˆç†Ÿï¼ˆ4å°æ—¶-12å°æ—¶ï¼‰
  cocoa:      { id: "cocoa",      name: "å¯å¯è±†",  cost: 110, sell: 360,  exp: 90,  stages: [4800, 9600, 14400], witherAfter: 2400, emoji: "ğŸ«", levelReq: 10 },     // 4å°æ—¶æˆç†Ÿï¼Œæ¯è40åˆ†é’Ÿ
  tea:        { id: "tea",        name: "èŒ¶å¶",    cost: 140, sell: 460,  exp: 110, stages: [7200, 14400, 21600], witherAfter: 2700, emoji: "ğŸµ", levelReq: 11 },     // 6å°æ—¶æˆç†Ÿï¼Œæ¯è45åˆ†é’Ÿ
  chili:      { id: "chili",      name: "è¾£æ¤’",    cost: 160, sell: 520,  exp: 125, stages: [9600, 19200, 28800], witherAfter: 3000, emoji: "ğŸŒ¶ï¸", levelReq: 12 },     // 8å°æ—¶æˆç†Ÿï¼Œæ¯è50åˆ†é’Ÿ
  rice:       { id: "rice",       name: "æ°´ç¨»",    cost: 190, sell: 600,  exp: 140, stages: [14400, 28800, 43200], witherAfter: 3300, emoji: "ğŸš", levelReq: 13 },     // 12å°æ—¶æˆç†Ÿï¼Œæ¯è55åˆ†é’Ÿ
  // é¡¶çº§ä½œç‰©ï¼šè¶…é•¿æˆç†Ÿï¼ˆ16å°æ—¶-72å°æ—¶ï¼‰
  wheat:      { id: "wheat",      name: "å°éº¦",    cost: 220, sell: 690,  exp: 160, stages: [19200, 38400, 57600], witherAfter: 3480, emoji: "ğŸŒ¾", levelReq: 14 },     // 16å°æ—¶æˆç†Ÿï¼Œæ¯è58åˆ†é’Ÿ
  peach:      { id: "peach",      name: "æ¡ƒå­",    cost: 260, sell: 820,  exp: 190, stages: [21600, 43200, 86400], witherAfter: 3540, emoji: "ğŸ‘", levelReq: 15 },     // 24å°æ—¶æˆç†Ÿï¼Œæ¯è59åˆ†é’Ÿ
  pear:       { id: "pear",       name: "æ¢¨å­",    cost: 300, sell: 960,  exp: 220, stages: [43200, 86400, 129600], witherAfter: 3570, emoji: "ğŸ", levelReq: 16 },     // 36å°æ—¶æˆç†Ÿï¼Œæ¯è59.5åˆ†é’Ÿ
  mango:      { id: "mango",      name: "èŠ’æœ",    cost: 360, sell: 1150, exp: 260, stages: [57600, 115200, 172800], witherAfter: 3590, emoji: "ğŸ¥­", levelReq: 17 },     // 48å°æ—¶æˆç†Ÿï¼Œæ¯è59.8åˆ†é’Ÿ
  cherry:     { id: "cherry",     name: "æ¨±æ¡ƒ",    cost: 420, sell: 1350, exp: 300, stages: [86400, 172800, 259200], witherAfter: 3600, emoji: "ğŸ’", levelReq: 18 },     // 72å°æ—¶æˆç†Ÿï¼Œæ¯è60åˆ†é’Ÿ
};

// æ‰©å±•ç­‰çº§åˆ° 18 çº§ï¼ˆç»éªŒé˜ˆå€¼å·²é™ä½ä¸ºåŸæ¥çš„1/3ï¼‰
const LEVELS = [
  0, 10, 40, 100, 200, 400, 800, 1400, 2200, 3200,
  4400, 5600, 6800, 8200, 9800, 11600, 13600, 15800
];

function getLevel(exp) {
  let lvl = 1;
  for (let i = 0; i < LEVELS.length; i++) if (exp >= LEVELS[i]) lvl = i + 1;
  return Math.min(lvl, LEVELS.length);
}

function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
function now() { return Math.floor(Date.now() / 1000); }
function fmtTime(sec) {
  if (sec <= 0) return "0ç§’";
  const m = Math.floor(sec / 60); const s = sec % 60;
  if (m > 0 && s > 0) return `${m}åˆ†${s}ç§’`;
  if (m > 0) return `${m}åˆ†`;
  return `${s}ç§’`;
}

// é¼ æ ‡æŒ‡é’ˆï¼ˆç®€å• SVG DataURLï¼‰
function cursorForTool(tool) {
  const map = { plant: "ğŸŒ±", harvest: "ğŸ§º", water: "ğŸ’§", weed: "ğŸŒ¿", pesticide: "ğŸª²", shovel: "ğŸª“" };
  const emoji = map[tool] || "";
  if (!emoji) return "auto";
  const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text x='0' y='24' font-size='24'>${emoji}</text></svg>`);
  return `url("data:image/svg+xml;utf8,${svg}") 4 24, auto`;
}

// æ›´é€¼çœŸçš„é»„åœŸåœ°çº¹ç†æ ·å¼ï¼ˆæ¸å˜ + ç»†ç‚¹å™ªå£°ï¼‰
function soilTextureStyle() {
  const baseGrad = `linear-gradient(to bottom, #d1a672, #c7924f)`; // æ£•é»„åˆ°åœŸé»„
  const noise1 = `radial-gradient(1px 1px at 10px 10px, rgba(80,50,20,0.08) 1px, transparent 1px)`;
  const noise2 = `radial-gradient(1px 1px at 20px 18px, rgba(80,50,20,0.06) 1px, transparent 1px)`;
  const noise3 = `radial-gradient(1px 1px at 15px 25px, rgba(80,50,20,0.05) 1px, transparent 1px)`;
  return {
    backgroundImage: `${baseGrad}, ${noise1}, ${noise2}, ${noise3}`,
    backgroundSize: `100% 100%, 22px 22px, 28px 28px, 26px 26px`,
    backgroundBlendMode: 'multiply',
    borderColor: '#b07a3d',
  };
}

/**********************
 * å­˜æ¡£ä¸é»˜è®¤çŠ¶æ€      *
 **********************/
// è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰
function getTodayDateStr() {
  const today = new Date();
  return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
}

const DEFAULT_SAVE = {
  coins: 9999,    // åˆå§‹9999é‡‘å¸
  zeta: 0,        // åˆå§‹æ²¡æœ‰ZETA
  tickets: 0,     // åˆå§‹æ²¡æœ‰å¥–åˆ¸
  exp: 0,         // åˆå§‹ç»éªŒå€¼ä¸º0ï¼Œç­‰çº§1
  protectFreeUsed: false,  // ä»Šå¤©æ˜¯å¦å·²ä½¿ç”¨å…è´¹ä¿æŠ¤
  protectBoughtToday: 0,   // ä»Šå¤©è´­ä¹°ä¿æŠ¤çš„æ¬¡æ•°
  protectLastDate: getTodayDateStr(), // æœ€åä½¿ç”¨ä¿æŠ¤çš„æ—¥æœŸ
  plots: Array.from({ length: 18 }).map((_, i) => ({
    id: i,
    unlocked: i === 0,  // åªæœ‰ç¬¬ä¸€å—åœ°é»˜è®¤è§£é”
    seedId: null,
    plantedAt: null,
    fertilized: false,
    wateredAt: null,
    weeds: false,
    pests: false,
    waterRequirements: [],  // æµ‡æ°´éœ€æ±‚æ—¶é—´ç‚¹æ•°ç»„ [{time: seconds, done: false}]
    weedRequirements: [],   // é™¤è‰éœ€æ±‚æ—¶é—´ç‚¹æ•°ç»„ [{time: seconds, done: false}]
    pausedDuration: 0,      // ç´¯è®¡æš‚åœç”Ÿé•¿çš„æ—¶é—´ï¼ˆç§’ï¼‰
    protectedUntil: 0,
  })),
  // åˆå§‹èƒŒåŒ…ï¼š1ä¸ªèƒ¡èåœç§å­
  inventory: { radish: 1 },
  fruits: {}, // åˆå§‹æ²¡æœ‰æœå®åº“å­˜
  selectedSeed: null,
  tool: "harvest",
  lastLogin: now(),
  __testingBoostApplied: false,
};

/**********************
 * æ¸¸æˆé€»è¾‘æ ¸å¿ƒ        *
 **********************/
function stageOf(plot) {
  if (!plot.seedId || !plot.plantedAt) return STAGE.EMPTY;
  const seed = SEEDS[plot.seedId];
  // å®é™…ç”Ÿé•¿æ—¶é—´ = æ€»æ—¶é—´ - æš‚åœæ—¶é—´
  const elapsed = (now() - plot.plantedAt) - (plot.pausedDuration || 0);
  const [s1, s2, s3] = seed.stages;
  const aliveUntil = s3 + seed.witherAfter;
  if (elapsed < s1) return STAGE.SEED;
  if (elapsed < s2) return STAGE.SPROUT;
  if (elapsed < s3) return STAGE.GROWING;
  if (elapsed < aliveUntil) return STAGE.RIPE;
  return STAGE.WITHER;
}

function yieldAmount(plot) {
  // ç§æ¤å’Œæ”¶è·æ˜¯1:1ï¼Œç§1ä¸ªå¾—1ä¸ª
  if (!plot.seedId || !plot.plantedAt) return 0;
  return 1;
}

function timeToNextStage(plot) {
  if (!plot.seedId || !plot.plantedAt) return 0;
  const seed = SEEDS[plot.seedId];
  // å®é™…ç”Ÿé•¿æ—¶é—´ = æ€»æ—¶é—´ - æš‚åœæ—¶é—´
  const elapsed = (now() - plot.plantedAt) - (plot.pausedDuration || 0);
  const [s1, s2, s3] = seed.stages;
  if (elapsed < s1) return s1 - elapsed;
  if (elapsed < s2) return s2 - elapsed;
  if (elapsed < s3) return s3 - elapsed;
  const aliveUntil = s3 + seed.witherAfter;
  if (elapsed < aliveUntil) return aliveUntil - elapsed; // è·ç¦»æ¯è
  return 0;
}

// æ ¹æ®ä½œç‰©ç­‰çº§è·å–æµ‡æ°´æ¬¡æ•°å’Œé™¤è‰æ¬¡æ•°
function getWateringCount(levelReq) {
  // æŒ‰ç…§è¡¨æ ¼ï¼š1-3çº§:1æ¬¡, 4-6çº§:2æ¬¡, 7-9çº§:3æ¬¡, 10-12çº§:4æ¬¡, 13çº§:4æ¬¡, 14-15çº§:5æ¬¡, 16-18çº§:5æ¬¡
  if (levelReq <= 3) return 1;
  if (levelReq <= 6) return 2;
  if (levelReq <= 9) return 3;
  if (levelReq <= 12) return 4;
  if (levelReq === 13) return 4;
  if (levelReq <= 15) return 5;
  return 5; // 16-18
}

function getWeedingCount(levelReq) {
  // æŒ‰ç…§è¡¨æ ¼ï¼š1-3çº§:0æ¬¡, 4-6çº§:1æ¬¡, 7-9çº§:2æ¬¡, 10-12çº§:3æ¬¡, 13çº§:4æ¬¡, 14-15çº§:4æ¬¡, 16-18çº§:5æ¬¡
  if (levelReq <= 3) return 0;
  if (levelReq <= 6) return 1;
  if (levelReq <= 9) return 2;
  if (levelReq <= 12) return 3;
  if (levelReq === 13) return 4;
  if (levelReq <= 15) return 4;
  if (levelReq <= 18) return 5;
  return 5;
}

// è®¡ç®—å¼€å¦åœŸåœ°çš„ä»·æ ¼ï¼ˆæ ¹æ®åœŸåœ°åºå·ï¼Œä»·æ ¼é€’å¢ï¼‰
function getPlotUnlockCost(plotId) {
  // ç¬¬ä¸€å—åœ°å…è´¹ï¼Œåç»­åœŸåœ°ä»·æ ¼é€’å¢
  // åŸºäºä½œç‰©å¹³å‡æ”¶ç›Šæ¥è®¡ç®—ï¼šå‡è®¾æ¯å—åœŸåœ°å¹³å‡æ”¶ç›Šé€’å¢
  // 1-3å—ï¼š50, 100, 150
  // 4-6å—ï¼š250, 400, 600
  // 7-9å—ï¼š1000, 1500, 2200
  // 10-12å—ï¼š3200, 4500, 6000
  // 13-15å—ï¼š8000, 11000, 15000
  // 16-18å—ï¼š20000, 28000, 40000
  const costs = [
    0,     // ç¬¬0å—å…è´¹
    50,    // ç¬¬1å—
    100,   // ç¬¬2å—
    150,   // ç¬¬3å—
    250,   // ç¬¬4å—
    400,   // ç¬¬5å—
    600,   // ç¬¬6å—
    1000,  // ç¬¬7å—
    1500,  // ç¬¬8å—
    2200,  // ç¬¬9å—
    3200,  // ç¬¬10å—
    4500,  // ç¬¬11å—
    6000,  // ç¬¬12å—
    8000,  // ç¬¬13å—
    11000, // ç¬¬14å—
    15000, // ç¬¬15å—
    20000, // ç¬¬16å—
    28000, // ç¬¬17å—
    40000, // ç¬¬18å—
  ];
  return costs[plotId] || 50000;
}

// è®¡ç®—å¼€å¦åœŸåœ°æ‰€éœ€çš„ç­‰çº§ï¼ˆæ ¹æ®åœŸåœ°åºå·ï¼Œç­‰çº§é€’å¢ï¼‰
function getPlotUnlockLevel(plotId) {
  // ç¬¬0å—å…è´¹æ— ç­‰çº§è¦æ±‚
  // åç»­åœŸåœ°æ¯3å—æå‡1çº§ï¼Œæœ€é«˜18çº§
  if (plotId === 0) return 1;
  if (plotId <= 3) return 2;
  if (plotId <= 6) return 4;
  if (plotId <= 9) return 6;
  if (plotId <= 12) return 9;
  if (plotId <= 15) return 12;
  return 15; // 16-18å—éœ€è¦15çº§
}

function randomChance(prob) { return Math.random() < prob; }
function replacePlot(arr, plot) { return arr.map((p) => (p.id === plot.id ? plot : p)); }

/**********************
 * ä¸»ç»„ä»¶              *
 **********************/
function SocialFarmGame() {
  const [save, setSave] = useState(() => {
    const raw = localStorage.getItem("social-farm-save-v1");
    if (raw) { try { return JSON.parse(raw); } catch (e) { console.warn("Load save failed", e); } }
    return { ...DEFAULT_SAVE };
  });

  const lvl = useMemo(() => getLevel(save.exp), [save.exp]);

  // æµ‹è¯•åŠ æˆåŠŸèƒ½å·²ç§»é™¤ï¼Œæ–°ç”¨æˆ·ä½¿ç”¨DEFAULT_SAVEçš„é»˜è®¤å€¼

  // è‡ªåŠ¨ä¿å­˜
  useEffect(() => { localStorage.setItem("social-farm-save-v1", JSON.stringify(save)); }, [save]);

  // æ¯ç§’ï¼šæ£€æŸ¥æµ‡æ°´/é™¤è‰éœ€æ±‚å¹¶æš‚åœç”Ÿé•¿ï¼Œéšæœºäº‹ä»¶ï¼ˆå®³è™«ï¼‰
  useEffect(() => {
    const id = setInterval(() => {
      setSave((prev) => {
        const next = { ...prev };
        next.plots = prev.plots.map((p) => {
          if (!p.seedId || !p.plantedAt) return p;
          
          // è®¡ç®—å®é™…ç”Ÿé•¿æ—¶é—´ï¼ˆä¸åŒ…å«æš‚åœæ—¶é—´ï¼‰
          const actualElapsed = (now() - p.plantedAt) - (p.pausedDuration || 0);
          let updated = false;
          let hasActiveWaterReq = false;
          let hasActiveWeedReq = false;
          
          // æ£€æŸ¥æµ‡æ°´éœ€æ±‚
          for (let req of (p.waterRequirements || [])) {
            if (!req.done && actualElapsed >= req.time) {
              hasActiveWaterReq = true;
              // å¦‚æœè¿˜æ²¡å¼€å§‹æš‚åœï¼Œè®°å½•æš‚åœå¼€å§‹æ—¶é—´
              if (!p.pausedAt) {
                p = { ...p, pausedAt: now() };
                updated = true;
              }
            }
          }
          
          // æ£€æŸ¥é™¤è‰éœ€æ±‚
          for (let req of (p.weedRequirements || [])) {
            if (!req.done && actualElapsed >= req.time) {
              hasActiveWeedReq = true;
              // å¦‚æœè¿˜æ²¡å¼€å§‹æš‚åœï¼Œè®°å½•æš‚åœå¼€å§‹æ—¶é—´
              if (!p.pausedAt) {
                p = { ...p, pausedAt: now() };
                updated = true;
              }
            }
          }
          
          // å¦‚æœæœ‰æœªå®Œæˆçš„éœ€æ±‚ï¼Œç´¯è®¡æš‚åœæ—¶é—´
          if (hasActiveWaterReq || hasActiveWeedReq) {
            if (p.pausedAt) {
              const pausedSince = now() - p.pausedAt;
              p = { ...p, pausedDuration: (p.pausedDuration || 0) + 1 };
              updated = true;
            }
          } else if (p.pausedAt) {
            // æ‰€æœ‰éœ€æ±‚éƒ½å®Œæˆäº†ï¼Œæ¸…é™¤æš‚åœ
            p = { ...p, pausedAt: null };
            updated = true;
          }
          
          // éšæœºäº‹ä»¶ï¼šå®³è™«ï¼ˆä¸æš‚åœç”Ÿé•¿ï¼‰
          const st = stageOf(p);
          if (st === STAGE.RIPE || st === STAGE.GROWING) {
            const pests = p.pests || randomChance(0.004);
            return { ...p, pests };
          }
          
          return p;
        });
        return next;
      });
    }, TICK_MS);
    return () => clearInterval(id);
  }, []);

  // å·¥å…·/ç§å­é€‰æ‹© + æŒ‡é’ˆ
  function setTool(t) { setSave((s) => ({ ...s, tool: t })); }
  useEffect(() => {
    const c = cursorForTool(save.tool);
    const prev = document.body.style.cursor;
    document.body.style.cursor = c;
    return () => { document.body.style.cursor = prev; };
  }, [save.tool]);

  function selectSeed(id) { setSave((s) => ({ ...s, selectedSeed: id, tool: "plant" })); }

  // è´­ä¹°ç§å­ï¼ˆåªèƒ½ç”¨é‡‘å¸ï¼Œæ— ç­‰çº§é™åˆ¶ï¼‰
  function buySeed(id, count = 1) {
    const seed = SEEDS[id];
    if (!seed) return toast("æœªçŸ¥ç§å­");
    const cost = seed.cost * count;
    if (save.coins < cost) return toast("é‡‘å¸ä¸è¶³");
    setSave((s) => ({
      ...s,
      coins: s.coins - cost,
      inventory: { ...s.inventory, [id]: (s.inventory[id] || 0) + count },
    }));
    toast(`è´­ä¹° ${seed.name} Ã—${count}ï¼Œæ¶ˆè€— ${cost} é‡‘å¸`);
  }

  // è¡Œä¸ºï¼šæ’­ç§/æ”¶è·/ç­‰
  function plant(plot) {
    if (!plot.unlocked) return toast("è¯·å…ˆå¼€å¦åœŸåœ°");
    if (!save.selectedSeed) return toast("å…ˆåœ¨èƒŒåŒ…é€‰æ‹©ç§å­");
    if (plot.seedId) return toast("åœ°å—å·²è¢«å ç”¨");
    const sid = save.selectedSeed;
    if ((save.inventory[sid] || 0) <= 0) return toast("è¯¥ç§å­åº“å­˜ä¸è¶³");
    const seed = SEEDS[sid];
    const [s1, s2, s3] = seed.stages;
    
    // ç”Ÿæˆæµ‡æ°´éœ€æ±‚æ—¶é—´ç‚¹ï¼ˆåœ¨ç”Ÿé•¿è¿‡ç¨‹ä¸­éšæœºåˆ†å¸ƒï¼‰
    const waterCount = getWateringCount(seed.levelReq);
    const waterRequirements = [];
    for (let i = 0; i < waterCount; i++) {
      const time = Math.floor(Math.random() * (s3 - s1)) + s1;
      waterRequirements.push({ time, done: false });
    }
    waterRequirements.sort((a, b) => a.time - b.time); // æŒ‰æ—¶é—´æ’åº
    
    // ç”Ÿæˆé™¤è‰éœ€æ±‚æ—¶é—´ç‚¹
    const weedCount = getWeedingCount(seed.levelReq);
    const weedRequirements = [];
    for (let i = 0; i < weedCount; i++) {
      const time = Math.floor(Math.random() * (s3 - s1)) + s1;
      weedRequirements.push({ time, done: false });
    }
    weedRequirements.sort((a, b) => a.time - b.time); // æŒ‰æ—¶é—´æ’åº
    
    const newPlot = { 
      ...plot, 
      seedId: sid, 
      plantedAt: now(), 
      fertilized: false, 
      wateredAt: null, 
      weeds: false, 
      pests: false,
      waterRequirements,
      weedRequirements,
      pausedDuration: 0,
      pausedAt: null
    };
    const inv = { ...save.inventory, [sid]: (save.inventory[sid] || 0) - 1 };
    setSave((s) => ({ ...s, plots: replacePlot(s.plots, newPlot), inventory: inv }));
  }

  function harvest(plot) {
    if (!plot.unlocked) return;
    if (!plot.seedId) return;
    const st = stageOf(plot);
    if (st !== STAGE.RIPE) return toast("å°šæœªæˆç†Ÿ");
    const amount = yieldAmount(plot);
    const seed = SEEDS[plot.seedId];
    const exp = seed.exp * amount; // ç»éªŒå€¼ = åŸºç¡€ç»éªŒ Ã— æ”¶è·æ•°é‡
    const cleared = { 
      ...plot, 
      seedId: null, 
      plantedAt: null, 
      fertilized: false, 
      weeds: false, 
      pests: false, 
      waterRequirements: [],
      weedRequirements: [],
      pausedDuration: 0,
      pausedAt: null
    };
    setSave((s) => ({
      ...s,
      exp: s.exp + exp,
      plots: replacePlot(s.plots, cleared),
      fruits: { ...(s.fruits || {}), [plot.seedId]: ((s.fruits || {})[plot.seedId] || 0) + amount }
    }));
    toast(`æ”¶è· ${seed.name} Ã—${amount}ï¼Œç»éªŒ +${exp}ï¼Œå¯åœ¨å•†åº—å‡ºå”®è·å¾—é‡‘å¸`);
  }

  function water(plot) {
    if (!plot.unlocked) return;
    if (!plot.seedId) return;
    const actualElapsed = (now() - plot.plantedAt) - (plot.pausedDuration || 0);
    let next = { ...plot, wateredAt: now() };
    let completedAny = false;
    
    // æ£€æŸ¥å¹¶å®Œæˆå·²åˆ°è¾¾çš„æµ‡æ°´éœ€æ±‚
    const waterReqs = [...(plot.waterRequirements || [])];
    for (let i = 0; i < waterReqs.length; i++) {
      if (!waterReqs[i].done && actualElapsed >= waterReqs[i].time) {
        waterReqs[i] = { ...waterReqs[i], done: true };
        completedAny = true;
      }
    }
    
    if (completedAny) {
      next = { 
        ...next, 
        waterRequirements: waterReqs,
        pausedAt: null  // æ¸…é™¤æš‚åœï¼ˆå¦‚æœæ‰€æœ‰éœ€æ±‚éƒ½å®Œæˆäº†ä¼šåœ¨ä¸‹æ¬¡tickå¤„ç†ï¼‰
      };
      toast("å·²æ»¡è¶³æµ‡æ°´éœ€æ±‚");
    }
    
    setSave((s) => ({ ...s, plots: replacePlot(s.plots, next) }));
  }
  function weed(plot) {
    if (!plot.unlocked) return;
    if (!plot.seedId) return;
    const actualElapsed = (now() - plot.plantedAt) - (plot.pausedDuration || 0);
    let completedAny = false;
    
    // æ£€æŸ¥å¹¶å®Œæˆå·²åˆ°è¾¾çš„é™¤è‰éœ€æ±‚
    const weedReqs = [...(plot.weedRequirements || [])];
    for (let i = 0; i < weedReqs.length; i++) {
      if (!weedReqs[i].done && actualElapsed >= weedReqs[i].time) {
        weedReqs[i] = { ...weedReqs[i], done: true };
        completedAny = true;
      }
    }
    
    if (completedAny) {
      const next = { 
        ...plot, 
        weedRequirements: weedReqs,
        weeds: false,  // ä¹Ÿæ¸…é™¤æ‚è‰çŠ¶æ€
        pausedAt: null  // æ¸…é™¤æš‚åœ
      };
      setSave((s) => ({ ...s, plots: replacePlot(s.plots, next) }));
      toast("å·²æ»¡è¶³é™¤è‰éœ€æ±‚");
    } else if (plot.weeds) {
      // å¤„ç†éšæœºå‡ºç°çš„æ‚è‰ï¼ˆä¸å½±å“éœ€æ±‚ï¼‰
      setSave((s) => ({ ...s, plots: replacePlot(s.plots, { ...plot, weeds: false }) }));
    } else {
      toast("æ²¡æœ‰æ‚è‰");
    }
  }
  function pesticide(plot) { if (!plot.unlocked) return; if (!plot.seedId) return; if (!plot.pests) return toast("æ²¡æœ‰å®³è™«"); setSave((s) => ({ ...s, plots: replacePlot(s.plots, { ...plot, pests: false }) })); }
  function shovel(plot) {
    if (!plot.unlocked) return; 
    if (!plot.seedId) return; 
    const cleared = { 
      ...plot, 
      seedId: null, 
      plantedAt: null, 
      fertilized: false, 
      weeds: false, 
      pests: false, 
      waterRequirements: [],
      weedRequirements: [],
      pausedDuration: 0,
      pausedAt: null
    }; 
    setSave((s) => ({ ...s, plots: replacePlot(s.plots, cleared) })); 
  }
  // ä¿æŠ¤å†œåœºï¼ˆ30åˆ†é’Ÿï¼‰
  function protectFarm() {
    const durationSec = 1800; // 30åˆ†é’Ÿ
    const today = getTodayDateStr();
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥è®¡æ•°ï¼ˆæ–°çš„ä¸€å¤©ï¼‰
    const needReset = save.protectLastDate !== today;
    const protectFreeUsed = needReset ? false : (save.protectFreeUsed || false);
    const protectBoughtToday = needReset ? 0 : (save.protectBoughtToday || 0);
    
    // å¦‚æœæœ‰å…è´¹æ¬¡æ•°ï¼Œä½¿ç”¨å…è´¹ä¿æŠ¤
    if (!protectFreeUsed) {
      setSave((s) => ({
        ...s,
        plots: s.plots.map((p) => ({ ...p, protectedUntil: now() + durationSec })),
        protectFreeUsed: true,
        protectLastDate: today
      }));
      toast("å·²ä½¿ç”¨å…è´¹ä¿æŠ¤ï¼ŒæŒç»­30åˆ†é’Ÿ");
      return;
    }
    
    // å¦‚æœæ²¡æœ‰å…è´¹æ¬¡æ•°ï¼Œæ£€æŸ¥è´­ä¹°æ¬¡æ•°
    if (protectBoughtToday >= 3) {
      return toast("ä»Šæ—¥è´­ä¹°ä¿æŠ¤æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ3æ¬¡ï¼‰");
    }
    
    const cost = 100;
    if (save.coins < cost) return toast("é‡‘å¸ä¸è¶³ï¼Œéœ€è¦100é‡‘å¸");
    
    setSave((s) => ({
      ...s,
      coins: s.coins - cost,
      plots: s.plots.map((p) => ({ ...p, protectedUntil: now() + durationSec })),
      protectBoughtToday: protectBoughtToday + 1,
      protectLastDate: today
    }));
    toast(`å·²è´­ä¹°ä¿æŠ¤ï¼ŒæŒç»­30åˆ†é’Ÿï¼ˆä»Šæ—¥å‰©ä½™è´­ä¹°æ¬¡æ•°ï¼š${2 - protectBoughtToday}ï¼‰`);
  }
  
  // å¼€å¦åœŸåœ°
  function unlockPlot(plot) {
    if (plot.unlocked) return toast("åœŸåœ°å·²è§£é”");
    const cost = getPlotUnlockCost(plot.id);
    const requiredLevel = getPlotUnlockLevel(plot.id);
    const currentLevel = getLevel(save.exp);
    
    if (currentLevel < requiredLevel) return toast(`ç­‰çº§ä¸è¶³ï¼Œéœ€è¦ç­‰çº§ ${requiredLevel}ï¼ˆå½“å‰ ${currentLevel} çº§ï¼‰`);
    if (save.coins < cost) return toast(`é‡‘å¸ä¸è¶³ï¼Œéœ€è¦ ${cost} é‡‘å¸`);
    
    setSave((s) => ({
      ...s,
      coins: s.coins - cost,
      plots: replacePlot(s.plots, { ...plot, unlocked: true })
    }));
    toast(`æˆåŠŸå¼€å¦åœŸåœ° #${plot.id + 1}ï¼Œæ¶ˆè€— ${cost} é‡‘å¸`);
  }

  // é‡ç½®ï¼ˆæ¢å¤åˆ°é»˜è®¤é…ç½®ï¼‰
  function resetSave() {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºå­˜æ¡£å¹¶é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿ")) return;
    const resetData = { ...DEFAULT_SAVE };
    localStorage.setItem("social-farm-save-v1", JSON.stringify(resetData));
    setSave(resetData);
    toast("å·²æ¸…ç©ºå­˜æ¡£å¹¶é‡ç½®ä¸ºé»˜è®¤é…ç½®");
  }

  // å¼¹çª—ï¼šå•†åº— / é“¶è¡Œ / Gluck
  const [shopOpen, setShopOpen] = useState(false);
  const [bankOpen, setBankOpen] = useState(false);
  const [gluckOpen, setGluckOpen] = useState(false);

  /**********************
   * æ¸²æŸ“                *
   **********************/
  return (
    <div className="min-h-screen relative text-slate-800 font-sans">
      <AutumnBackground />
      <div className="relative z-10" style={{ cursor: cursorForTool(save.tool) }}>
        <TopBar coins={save.coins} zeta={save.zeta} tickets={save.tickets} exp={save.exp} level={lvl} onProtect={protectFarm} />
        <Banner />
        <div className="max-w-6xl mx-auto px-3 pb-24">
          <div className="grid md:grid-cols-12 gap-3 mt-3">
            <div className="md:col-span-9">
              <Board
                plots={save.plots}
                onPlotClick={(p) => {
                  if (!p.unlocked) return unlockPlot(p);
                  switch (save.tool) {
                    case "plant": plant(p); break;
                    case "harvest": harvest(p); break;
                    case "water": water(p); break;
                    case "weed": weed(p); break;
                    case "pesticide": pesticide(p); break;
                    case "shovel": shovel(p); break;
                    default: break;
                  }
                }}
                onHarvest={harvest}
                onShovel={shovel}
                onUnlock={unlockPlot}
              />
            </div>
            <div className="md:col-span-3">
              <Toolbox current={save.tool} setTool={setTool} />
              <BagPanel inventory={save.inventory} fruits={save.fruits || {}} selected={save.selectedSeed} onSelect={selectSeed} />
              <div className="grid grid-cols-3 gap-2 mt-3">
                <button className="w-full text-sm px-3 py-2 rounded-xl border bg-white/90 backdrop-blur hover:bg-white" onClick={() => setShopOpen(true)}>ğŸ›’ å•†åº—</button>
                <button className="w-full text-sm px-3 py-2 rounded-xl border bg-white/90 backdrop-blur hover:bg-white" onClick={() => setBankOpen(true)}>ğŸ¦ é“¶è¡Œ</button>
                <button className="w-full text-sm px-3 py-2 rounded-xl border bg-white/90 backdrop-blur hover:bg-white" onClick={() => setGluckOpen(true)}>ğŸ° Gluck</button>
              </div>
              <SettingsPanel onReset={resetSave} />
            </div>
          </div>
        </div>
        <ShopModal 
          open={shopOpen} 
          onClose={() => setShopOpen(false)} 
          buySeed={buySeed} 
          sellFruit={(id, count) => {
            const seed = SEEDS[id];
            if (!seed) return toast("æœªçŸ¥ä½œç‰©");
            const fruits = save.fruits || {};
            const available = fruits[id] || 0;
            if (available < count) return toast("æœå®ä¸è¶³");
            
            // å•†åº—åªèƒ½å–æˆé‡‘å¸
            const income = seed.sell * count;
            setSave((s) => ({
              ...s,
              coins: s.coins + income,
              fruits: { ...s.fruits, [id]: (s.fruits[id] || 0) - count }
            }));
            toast(`å‡ºå”® ${seed.name} Ã—${count}ï¼Œè·å¾— ${income} é‡‘å¸`);
          }} 
          fruits={save.fruits || {}} 
        />
        <BankModal 
          open={bankOpen} 
          onClose={() => setBankOpen(false)} 
          coins={save.coins}
          onExchange={(amount, targetCurrency) => {
            // ZETAæ±‡ç‡ 1:10ï¼ˆ10é‡‘å¸ = 1 ZETAï¼‰ï¼Œå¥–åˆ¸æ±‡ç‡ 1:70ï¼ˆ70é‡‘å¸ = 1 å¥–åˆ¸ï¼‰
            if (save.coins < amount) return toast("é‡‘å¸ä¸è¶³");
            const exchangeRate = targetCurrency === 'zeta' ? 10 : 70;
            const exchangeAmount = Math.floor(amount / exchangeRate);
            const minAmount = targetCurrency === 'zeta' ? 10 : 70;
            if (exchangeAmount < 1) return toast(`å…‘æ¢æ•°é‡è‡³å°‘éœ€è¦${minAmount}é‡‘å¸`);
            
            setSave((s) => ({
              ...s,
              coins: s.coins - amount,
              [targetCurrency]: (s[targetCurrency] || 0) + exchangeAmount
            }));
            
            const currencyName = targetCurrency === 'zeta' ? 'ZETA' : 'å¥–åˆ¸';
            toast(`å…‘æ¢æˆåŠŸï¼š${amount} é‡‘å¸ â†’ ${exchangeAmount} ${currencyName}`);
          }}
        />
        <GluckModal open={gluckOpen} onClose={() => setGluckOpen(false)} onDraw={(n)=>doGluck(n)} tickets={save.tickets} />
        <ToastArea />
      </div>
    </div>
  );

  // ====== Gluck é€»è¾‘ ======
  function doGluck(count = 1) {
    const cost = count; // æ¯æŠ½ 1 å¼ å¥–åˆ¸
    if (save.tickets < cost) return toast("å¥–åˆ¸ä¸è¶³");

    // ç§å­åŒ…æ¦‚ç‡åˆ†å¸ƒï¼ˆæŒ‰ç­‰çº§åˆ†ç»„ï¼Œç´¯è®¡æ¦‚ç‡ï¼‰
    const seedPools = [
      // ä½çº§ç§å­ï¼ˆ1-2çº§ï¼‰ï¼š35%æ¦‚ç‡ï¼Œæ•°é‡3-5ä¸ª
      { seeds: ['radish', 'strawberry'], prob: 0.35, minQty: 3, maxQty: 5 },
      // ä½çº§ç§å­ï¼ˆ3-4çº§ï¼‰ï¼š20%æ¦‚ç‡ï¼Œæ•°é‡1-3ä¸ª
      { seeds: ['corn', 'grape'], prob: 0.55, minQty: 1, maxQty: 3 },
      // ä¸­çº§ç§å­ï¼ˆ5-6çº§ï¼‰ï¼š15%æ¦‚ç‡ï¼Œæ•°é‡1-2ä¸ª
      { seeds: ['tomato', 'blueberry'], prob: 0.70, minQty: 1, maxQty: 2 },
      // ä¸­çº§ç§å­ï¼ˆ7-8çº§ï¼‰ï¼š12%æ¦‚ç‡ï¼Œæ•°é‡1-2ä¸ª
      { seeds: ['pumpkin', 'pineapple'], prob: 0.82, minQty: 1, maxQty: 2 },
      // é«˜çº§ç§å­ï¼ˆ9-10çº§ï¼‰ï¼š5%æ¦‚ç‡ï¼Œæ•°é‡1-2ä¸ª
      { seeds: ['coffee', 'cocoa'], prob: 0.87, minQty: 1, maxQty: 2 },
      // é«˜çº§ç§å­ï¼ˆ11-12çº§ï¼‰ï¼š3%æ¦‚ç‡ï¼Œæ•°é‡1-2ä¸ª
      { seeds: ['tea', 'chili'], prob: 0.90, minQty: 1, maxQty: 2 },
      // é¡¶çº§ç§å­ï¼ˆ13-14çº§ï¼‰ï¼š0.005%æ¦‚ç‡ï¼Œæ•°é‡1ä¸ª
      { seeds: ['rice', 'wheat'], prob: 0.90005, minQty: 1, maxQty: 1 },
      // é¡¶çº§ç§å­ï¼ˆ15-16çº§ï¼‰ï¼š0.003%æ¦‚ç‡ï¼Œæ•°é‡1ä¸ª
      { seeds: ['peach', 'pear'], prob: 0.90008, minQty: 1, maxQty: 1 },
      // ç¨€æœ‰ç§å­ï¼ˆ17-18çº§ï¼‰ï¼š0.001%æ¦‚ç‡ï¼Œæ•°é‡1ä¸ª
      { seeds: ['mango', 'cherry'], prob: 0.90009, minQty: 1, maxQty: 1 },
    ];

    const rewards = [];
    for (let i = 0; i < count; i++) {
      const r = Math.random();
      
      // æ ¹æ®éšæœºæ•°é€‰æ‹©ç§å­æ± 
      let selectedPool = null;
      for (const pool of seedPools) {
        if (r <= pool.prob) {
          selectedPool = pool;
          break;
        }
      }
      
      if (selectedPool) {
        // ä»è¯¥æ± ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªç§å­
        const seedId = selectedPool.seeds[Math.floor(Math.random() * selectedPool.seeds.length)];
        // éšæœºæ•°é‡
        const qty = selectedPool.minQty + Math.floor(Math.random() * (selectedPool.maxQty - selectedPool.minQty + 1));
        rewards.push({ type: 'seed', id: seedId, qty });
      }
    }

    // åº”ç”¨å¥–åŠ±
    setSave((s) => {
      const next = { ...s, tickets: s.tickets - cost, inventory: { ...(s.inventory || {}) } };
      const seedGains = [];
      rewards.forEach((rw) => {
        if (rw.type === 'seed') {
          next.inventory[rw.id] = (next.inventory[rw.id] || 0) + rw.qty;
          seedGains.push(`${SEEDS[rw.id].emoji} ${SEEDS[rw.id].name}Ã—${rw.qty}`);
        }
      });
      
      // æ±‡æ€»æç¤º
      if (seedGains.length > 0) {
        toast(`æŠ½åˆ°ï¼š${seedGains.join('ã€')}`);
      } else {
        toast('ä¸‹æ¬¡å¿…å‡ºå¥½è¿ï¼');
      }
      return next;
    });
  }
}

/**********************
 * å­ç»„ä»¶              *
 **********************/
function TopBar({ coins, zeta, tickets, exp, level, onProtect }) {
  const nextLvl = clamp(level, 1, LEVELS.length);
  const curNeed = LEVELS[nextLvl - 1] ?? 0;
  const nextNeed = LEVELS[nextLvl] ?? LEVELS[LEVELS.length - 1];
  const prog = LEVELS[nextLvl] ? clamp((exp - curNeed) / (nextNeed - curNeed), 0, 1) : 1;
  
  // è®¡ç®—å‡çº§æ‰€éœ€ç»éªŒ
  const expNeeded = nextNeed > exp ? nextNeed - exp : 0;
  const isMaxLevel = level >= LEVELS.length;
  
  return (
    <div className="bg-white/80 backdrop-blur sticky top-0 z-50 shadow-sm border-b border-amber-200/50">
      <div className="max-w-6xl mx-auto px-3 py-2 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="text-2xl font-serif">ZETA Farm</div>
          <div className="text-sm text-slate-500 hidden md:block">åˆ‡æ¢è¯­è¨€</div>
        </div>
        <div className="flex items-center gap-2 sm:gap-3">
          <div className="px-2 sm:px-3 py-1 rounded-full bg-amber-100 border border-amber-200/80">ğŸ’° <b>{coins}</b></div>
          <div className="px-2 sm:px-3 py-1 rounded-full bg-cyan-100 border border-cyan-200/80">Î– <b>{zeta}</b></div>
          <div className="px-2 sm:px-3 py-1 rounded-full bg-pink-100 border border-pink-200/80">ğŸŸï¸ <b>{tickets}</b></div>
          <div className="px-2 sm:px-3 py-1 rounded-full bg-indigo-100 border border-indigo-200/80">â­ <b>{exp}</b></div>
          <div className="relative group">
            <div className="px-2 sm:px-3 py-1 rounded-full bg-emerald-100 border border-emerald-200/80">ğŸ–ï¸ ç­‰çº§<b>{level}</b></div>
            {!isMaxLevel && (
              <div className="pointer-events-none absolute z-10 hidden group-hover:block right-0 mt-2 w-48 p-2 rounded-lg border bg-white shadow-lg text-center">
                <div className="text-sm text-slate-700">å‡çº§åˆ°ç­‰çº§ {level + 1}</div>
                <div className="text-xs text-slate-500 mt-1">éœ€è¦ç»éªŒï¼š<b>{expNeeded}</b></div>
              </div>
            )}
          </div>
          <button className="px-3 py-1 rounded-full bg-rose-100 border border-rose-200/80 hover:bg-rose-200" onClick={onProtect}>ğŸ›¡ï¸ ä¿æŠ¤ 30 åˆ†é’Ÿ</button>
        </div>
      </div>
      <div className="h-1 bg-amber-200/40">
        <div className="h-full bg-emerald-500" style={{ width: `${prog * 100}%` }} />
      </div>
    </div>
  );
}

function Banner() {
  return (
    <div 
      className="text-white py-2 text-center relative overflow-hidden"
      style={{
        background: 'linear-gradient(135deg, #065f46 0%, #047857 25%, #059669 50%, #047857 75%, #065f46 100%)',
        backgroundSize: '200% 200%',
        animation: 'gradientShift 3s ease infinite'
      }}
    >
      <style>{`
        @keyframes gradientShift {
          0%, 100% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
        }
      `}</style>
      <div className="max-w-6xl mx-auto px-3 text-sm font-medium relative z-10">
        ZETAå†œåº„è¿æ¥S1èµ›å­£ å½“å‰å‰©ä½™å¥–åŠ± 6000 ZETA
      </div>
    </div>
  );
}

function Board({ plots, onPlotClick, onHarvest, onShovel, onUnlock }) {
  return (
    <div className="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
      {plots.map((p) => (
        <PlotTile key={p.id} plot={p} onClick={() => onPlotClick(p)} onHarvest={onHarvest} onShovel={onShovel} onUnlock={onUnlock} />
      ))}
    </div>
  );
}

function PlotTile({ plot, onClick, onHarvest, onShovel, onUnlock }) {
  const st = stageOf(plot);
  const seed = plot.seedId ? SEEDS[plot.seedId] : null;
  const timeNext = timeToNextStage(plot);
  const isProtected = (plot.protectedUntil || 0) > now();
  
  // å¦‚æœæœªè§£é”ï¼Œæ˜¾ç¤ºå¼€å¦ç•Œé¢
  if (!plot.unlocked) {
    const unlockCost = getPlotUnlockCost(plot.id);
    const requiredLevel = getPlotUnlockLevel(plot.id);
    return (
      <div className="relative select-none p-2 rounded-3xl border shadow-sm bg-gray-100/50 opacity-60">
        <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
          <span>#{plot.id + 1}</span>
          <span className="text-slate-400">ğŸ”’ æœªå¼€å¦</span>
        </div>
        <div className="flex flex-col items-center py-6 h-32 justify-center">
          <div className="text-3xl opacity-50">ğŸ”’</div>
          <div className="text-sm mt-2 font-medium text-slate-600">è’åœ°</div>
          <div className="text-[10px] mt-1 text-slate-500">éœ€è¦ç­‰çº§ {requiredLevel}</div>
        </div>
        <button 
          className="w-full mt-2 text-sm py-1.5 rounded-2xl border bg-white/90 hover:bg-white text-slate-700" 
          onClick={(e) => { e.stopPropagation(); if (onUnlock) onUnlock(plot); }}
        >
          ğŸ’° {unlockCost} é‡‘å¸
        </button>
      </div>
    );
  }
  
  // è®¡ç®—å®é™…ç”Ÿé•¿æ—¶é—´ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æµ‡æ°´/é™¤è‰éœ€æ±‚
  // ä½¿ç”¨stateå¼ºåˆ¶é‡æ–°æ¸²æŸ“ä»¥å®æ—¶æ›´æ–°æ˜¾ç¤º
  const [refreshKey, setRefreshKey] = useState(0);
  useEffect(() => {
    const interval = setInterval(() => {
      setRefreshKey(prev => prev + 1);
    }, 1000);
    return () => clearInterval(interval);
  }, []);
  
  const actualElapsed = plot.seedId && plot.plantedAt 
    ? (now() - plot.plantedAt) - (plot.pausedDuration || 0) 
    : 0;
  const hasActiveWaterReq = (plot.waterRequirements || []).some(r => !r.done && actualElapsed >= r.time);
  const hasActiveWeedReq = (plot.weedRequirements || []).some(r => !r.done && actualElapsed >= r.time);

  const labelByStage = { EMPTY: "ç©ºåœ°", SEED: "æ’­ç§ä¸­", SPROUT: "å‘èŠ½", GROWING: "ç”Ÿé•¿", RIPE: "æˆç†Ÿ", WITHER: "æ¯è" };
  const stageEmoji = { EMPTY: "â¬œ", SEED: "ğŸŒ±", SPROUT: "ğŸŒ¿", GROWING: "ğŸŒ¾", RIPE: seed?.emoji ?? "ğŸ€", WITHER: "ğŸª¦" };
  
  // å¤„ç†æŒ‰é’®ç‚¹å‡»
  const handleButtonClick = (e) => {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœ°å—ç‚¹å‡»
    if (st === STAGE.RIPE && onHarvest) {
      onHarvest(plot);
    } else if (st === STAGE.WITHER && onShovel) {
      onShovel(plot);
    } else {
      onClick();
    }
  };

  return (
    <div onClick={onClick} className="relative select-none p-2 rounded-3xl border shadow-sm hover:shadow transition" style={soilTextureStyle()}>
      <div className="flex items-center justify-between text-xs text-amber-900/85">
        <span>#{plot.id + 1}</span>
        {isProtected && <span className="text-white">ğŸ›¡ï¸ä¿æŠ¤</span>}
      </div>
      <div className="flex flex-col items-center py-3 h-32 justify-center relative">
        <div className="text-4xl">{st === STAGE.RIPE && seed ? seed.emoji : stageEmoji[st]}</div>
        <div className="text-sm mt-1 font-medium text-amber-950">{seed ? seed.name : "ç©ºåœ°"}</div>
        <div className="text-xs text-amber-900/70 h-4">{seed ? labelByStage[st] : ""}</div>
        {seed && st === STAGE.RIPE && (
          <div className="text-[11px] text-amber-900/60 mt-1">è·æ¯èï¼š{fmtTime(timeNext)}</div>
        )}
      </div>
      {(plot.weeds || plot.pests || hasActiveWaterReq || hasActiveWeedReq) && (
        <div className="absolute bottom-12 left-0 right-0 flex gap-1 justify-center pointer-events-none z-20">
          {hasActiveWaterReq && <Badge text="ğŸ’§éœ€æ°´" color="bg-sky-700" />}
          {hasActiveWeedReq && <Badge text="ğŸŒ¿éœ€é™¤è‰" color="bg-lime-700" />}
          {plot.weeds && !hasActiveWeedReq && <Badge text="ğŸŒ¿æ‚è‰" color="bg-lime-700" />}
          {plot.pests && <Badge text="ğŸ›å®³è™«" color="bg-yellow-700" />}
        </div>
      )}
      <div className="relative w-full mt-2">
        <button className="w-full text-sm py-1.5 rounded-2xl border bg-white/90 hover:bg-white relative overflow-hidden" onClick={onClick}>
          {seed && st !== STAGE.WITHER && st !== STAGE.EMPTY && st !== STAGE.RIPE && (
            <div className="absolute inset-0 bg-green-100/30 rounded-2xl">
              <div 
                className="absolute inset-0 bg-green-400/40 rounded-2xl transition-all" 
                style={{ width: `${(() => {
                  const elapsed = (now() - plot.plantedAt) - (plot.pausedDuration || 0);
                  const [s1, s2, s3] = seed.stages;
                  if (st === STAGE.SEED) {
                    return Math.max(0, Math.min(100, (elapsed / s1) * 100));
                  } else if (st === STAGE.SPROUT) {
                    return Math.max(0, Math.min(100, ((elapsed - s1) / (s2 - s1)) * 100));
                  } else if (st === STAGE.GROWING) {
                    return Math.max(0, Math.min(100, ((elapsed - s2) / (s3 - s2)) * 100));
                  }
                  return 0;
                })()}%` }}
              />
            </div>
          )}
          <span className="relative z-10">
            {(() => {
              if (st === STAGE.EMPTY) return "ğŸ’¤ æ— äº‹å¯åš";
              if (st === STAGE.RIPE) return "ğŸ§º æ”¶è·";
              if (st === STAGE.WITHER) return "ğŸª“ é“²é™¤";
              return `${fmtTime(timeNext)}`;
            })()}
          </span>
        </button>
      </div>
    </div>
  );
}

function Badge({ text, color }) { return (<div className={`text-[10px] text-white px-1.5 py-0.5 rounded ${color}`}>{text}</div>); }

function Toolbox({ current, setTool }) {
  const tools = [
    { id: "harvest", label: "æ”¶è·", emoji: "ğŸ§º" },
    { id: "plant", label: "æ’­ç§", emoji: "ğŸŒ±" },
    { id: "water", label: "æµ‡æ°´", emoji: "ğŸ’§" },
    { id: "weed", label: "é™¤è‰", emoji: "ğŸŒ¿" },
    { id: "pesticide", label: "é™¤è™«", emoji: "ğŸª²" },
    { id: "shovel", label: "é“²é™¤", emoji: "ğŸª“" },
  ];
  return (
    <div className="bg-white/90 backdrop-blur rounded-2xl p-3 border shadow-sm">
      <div className="font-semibold mb-2">å·¥å…·ç®±</div>
      <div className="grid grid-cols-6 gap-2">
        {tools.map((t) => (
          <div key={t.id} className="relative group">
            <button onClick={() => setTool(t.id)} className={`w-full aspect-square rounded-xl border flex items-center justify-center text-2xl ${current === t.id ? 'border-emerald-400 bg-emerald-50' : 'bg-white hover:bg-slate-50'}`} title={t.label}>
              {t.emoji}
            </button>
            <div className="pointer-events-none absolute z-10 hidden group-hover:block left-1/2 -translate-x-1/2 mt-1 w-28 p-1.5 rounded-lg border bg-white shadow text-center">
              <div className="text-xs text-slate-700">{t.emoji} {t.label}</div>
            </div>
          </div>
        ))}
      </div>
      <div className="text-[11px] text-slate-500 mt-2">æç¤ºï¼šç‚¹å‡»æ ¼å­é€‰æ‹©å·¥å…·ï¼Œé¼ æ ‡å½¢æ€ä¼šå˜åŒ–ï¼›ç„¶åç‚¹å‡»åœ°å—æ‰§è¡Œæ“ä½œã€‚</div>
    </div>
  );
}

function BagPanel({ inventory, fruits, selected, onSelect }) {
  const entries = Object.values(SEEDS);
  
  return (
    <div className="bg-white/90 backdrop-blur rounded-2xl p-3 border shadow-sm mt-3">
      <div className="font-semibold mb-2">èƒŒåŒ…</div>
      {/* ç§å­åŒºåŸŸ */}
      <div className="mb-3">
        <div className="text-xs text-slate-500 mb-1">ğŸŒ± ç§å­</div>
        <div className="grid grid-cols-6 gap-2">
          {entries.map((s) => {
            const count = inventory[s.id] ?? 0;
            const hasCount = count > 0;
            return (
              <div key={s.id} className="relative group">
                <button
                  onClick={() => hasCount && onSelect(s.id)}
                  disabled={!hasCount}
                  className={`w-full aspect-square rounded-xl border flex items-center justify-center text-2xl relative overflow-hidden ${
                    !hasCount 
                      ? 'bg-gray-100 opacity-50 border-gray-200 cursor-not-allowed' 
                      : selected === s.id 
                        ? 'border-emerald-400 bg-emerald-50' 
                        : 'bg-white hover:bg-slate-50'
                  }`}
                  title={`${s.name}`}
                >
                  {hasCount && <div className="absolute inset-0 bg-amber-900/20 pointer-events-none" />}
                  <span className={`relative z-10 ${!hasCount ? 'opacity-40' : ''}`}>{s.emoji}</span>
                  {count > 0 && (
                    <div className="absolute bottom-0 left-0 right-0 h-1/5 bg-amber-800/80 flex items-center justify-center rounded-b-xl pointer-events-none z-20">
                      <span className="text-[7px] font-bold text-white">{count}</span>
                    </div>
                  )}
                </button>
                {/* æ‚¬æµ®è¯´æ˜ */}
                <div className="pointer-events-none absolute z-10 hidden group-hover:block left-1/2 -translate-x-1/2 mt-1 w-44 p-2 rounded-lg border bg-white shadow">
                  <div className="text-sm font-medium">{s.name} <span className="text-xs text-slate-400">Lv{s.levelReq}</span></div>
                  <div className="text-xs text-slate-600">æˆæœ¬ {s.cost}ï½œå”®å‡º {s.sell}ï½œç»éªŒ +{s.exp}</div>
                  <div className="text-[11px] text-slate-500">æˆç†Ÿçº¦ {fmtTime(s.stages[2])}ï¼Œæ¯è {fmtTime(s.witherAfter)} å</div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
      {/* æœå®åŒºåŸŸ */}
      <div>
        <div className="text-xs text-slate-500 mb-1">ğŸ æœå®</div>
        <div className="grid grid-cols-6 gap-2">
          {entries.map((s) => {
            const count = fruits[s.id] ?? 0;
            const hasCount = count > 0;
            return (
              <div key={s.id} className="relative group">
                <div
                  className={`w-full aspect-square rounded-xl border flex items-center justify-center text-2xl relative ${
                    !hasCount 
                      ? 'bg-gray-100 opacity-50 border-gray-200' 
                      : 'bg-white'
                  }`}
                  title={`${s.name}`}
                >
                  <span className={!hasCount ? 'opacity-40' : ''}>{s.emoji}</span>
                  {count > 0 && (
                    <div className="absolute bottom-0 left-0 right-0 h-1/5 bg-amber-800/80 flex items-center justify-center rounded-b-xl pointer-events-none z-20">
                      <span className="text-[7px] font-bold text-white">{count}</span>
                    </div>
                  )}
                </div>
                {/* æ‚¬æµ®è¯´æ˜ */}
                {hasCount && (
                  <div className="pointer-events-none absolute z-10 hidden group-hover:block left-1/2 -translate-x-1/2 mt-1 w-44 p-2 rounded-lg border bg-white shadow">
                    <div className="text-sm font-medium">{s.name}</div>
                    <div className="text-xs text-slate-600">å”®å‡ºå•ä»· {s.sell} é‡‘å¸</div>
                    <div className="text-[11px] text-slate-500">å¯åœ¨å•†åº—å‡ºå”®</div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

function ShopModal({ open, onClose, buySeed, sellFruit, fruits }) {
  const [tab, setTab] = useState('buy'); // 'buy' or 'sell'
  const [seedId, setSeedId] = useState('radish');
  const [qty, setQty] = useState(1);
  const entries = Object.values(SEEDS);
  if (!open) return null;
  const seed = SEEDS[seedId];
  const fruitEntries = entries.filter(s => (fruits[s.id] || 0) > 0);
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="bg-white w-[min(640px,95vw)] rounded-2xl border shadow-lg p-4">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold text-lg">ğŸ›’ å•†åº—</div>
          <button onClick={onClose} className="text-slate-500 hover:text-slate-700">âœ–</button>
        </div>
        {/* æ ‡ç­¾é¡µåˆ‡æ¢ */}
        <div className="flex gap-2 mb-3 border-b">
          <button onClick={() => { setTab('buy'); setSeedId('radish'); }} className={`px-3 py-1 text-sm ${tab === 'buy' ? 'border-b-2 border-emerald-400 text-emerald-600' : 'text-slate-500'}`}>
            ğŸŒ± è´­ä¹°ç§å­
          </button>
          <button onClick={() => { setTab('sell'); if (fruitEntries.length > 0) setSeedId(fruitEntries[0].id); }} className={`px-3 py-1 text-sm ${tab === 'sell' ? 'border-b-2 border-emerald-400 text-emerald-600' : 'text-slate-500'}`}>
            ğŸ å‡ºå”®æœå®
          </button>
        </div>
        
        {tab === 'buy' ? (
          <div className="grid grid-cols-5 gap-2">
            <div className="col-span-3">
              <div className="grid grid-cols-5 gap-2 max-h-72 overflow-auto pr-1">
                {entries.map((s) => (
                  <button key={s.id} onClick={() => setSeedId(s.id)} className={`aspect-square rounded-xl border flex items-center justify-center text-2xl ${seedId === s.id ? 'border-emerald-400 bg-emerald-50' : 'bg-white hover:bg-slate-50'}`} title={s.name}>
                    {s.emoji}
                  </button>
                ))}
              </div>
            </div>
            <div className="col-span-2">
              <div className="text-base font-medium mb-1">{seed.name} <span className="text-xs text-slate-400">Lv{seed.levelReq}</span></div>
              <div className="text-sm text-slate-600">æˆæœ¬ {seed.cost} é‡‘å¸ï½œå”®å‡º {seed.sell} é‡‘å¸ï½œç»éªŒ +{seed.exp}</div>
              <div className="text-[11px] text-slate-500 mb-2">æˆç†Ÿçº¦ {fmtTime(seed.stages[2])}ï¼Œæ¯è {fmtTime(seed.witherAfter)} å</div>
              <div className="text-sm mb-2 text-slate-700">ğŸ’° é‡‘å¸è´­ä¹°</div>
              <div className="flex items-center gap-2 mb-2">
                <input type="number" min={1} value={qty} onChange={(e)=>setQty(clamp(parseInt(e.target.value||'1',10),1,999))} className="w-20 px-2 py-1 border rounded-lg" />
                <div className="text-sm text-slate-600">æ•°é‡</div>
                <div className="text-sm text-slate-600">æ€»ä»·ï¼š{seed.cost * qty} é‡‘å¸</div>
              </div>
              <div className="flex gap-2">
                <button onClick={()=>buySeed(seedId, qty)} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">è´­ä¹°</button>
                <button onClick={onClose} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å…³é—­</button>
              </div>
            </div>
          </div>
        ) : (
          <div className="grid grid-cols-5 gap-2">
            <div className="col-span-3">
              {fruitEntries.length > 0 ? (
                <div className="grid grid-cols-5 gap-2 max-h-72 overflow-auto pr-1">
                  {fruitEntries.map((s) => (
                    <button key={s.id} onClick={() => setSeedId(s.id)} className={`aspect-square rounded-xl border flex items-center justify-center text-2xl relative ${seedId === s.id ? 'border-emerald-400 bg-emerald-50' : 'bg-white hover:bg-slate-50'}`} title={s.name}>
                      {s.emoji}
                      <span className="absolute -top-1 -right-1 text-[10px] px-1 rounded bg-emerald-600 text-white">{fruits[s.id] || 0}</span>
                    </button>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 text-slate-400">æš‚æ— æœå®å¯å‡ºå”®</div>
              )}
            </div>
            <div className="col-span-2">
              {fruitEntries.length > 0 && seed ? (
                <>
                  <div className="text-base font-medium mb-1">{seed.name}</div>
                  <div className="text-sm text-slate-600 mb-2">å•ä»· {seed.sell} é‡‘å¸</div>
                  <div className="text-sm text-slate-500 mb-2">æŒæœ‰ï¼š{fruits[seed.id] || 0} ä¸ª</div>
                  <div className="flex items-center gap-2 mb-2">
                    <input type="number" min={1} max={fruits[seed.id] || 0} value={qty} onChange={(e)=>setQty(clamp(parseInt(e.target.value||'1',10),1,fruits[seed.id] || 0))} className="w-20 px-2 py-1 border rounded-lg" />
                    <div className="text-sm text-slate-600">æ•°é‡</div>
                  </div>
                  <div className="text-sm text-slate-700 mb-2">æ€»è®¡ï¼š{seed.sell * qty} é‡‘å¸</div>
                  <div className="text-[11px] text-slate-500 mb-2">ğŸ’° å•†åº—ä»…æ”¯æŒå‡ºå”®ä¸ºé‡‘å¸</div>
                  <div className="flex gap-2">
                    <button onClick={()=>{sellFruit(seedId, qty); setQty(1);}} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å‡ºå”®</button>
                    <button onClick={onClose} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å…³é—­</button>
                  </div>
                </>
              ) : (
                <div className="text-sm text-slate-400">è¯·é€‰æ‹©è¦å‡ºå”®çš„æœå®</div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function BankModal({ open, onClose, coins, onExchange }) {
  const [amount, setAmount] = useState(10);
  const [targetCurrency, setTargetCurrency] = useState('zeta');
  if (!open) return null;
  
  // ZETAæ±‡ç‡10:1ï¼Œå¥–åˆ¸æ±‡ç‡70:1
  const exchangeRate = targetCurrency === 'zeta' ? 10 : 70;
  const minAmount = targetCurrency === 'zeta' ? 10 : 70;
  // ç¡®ä¿é‡‘é¢ä¸å°äºæœ€å°é‡‘é¢
  const validAmount = Math.max(amount, minAmount);
  const exchangeAmount = Math.floor(validAmount / exchangeRate);
  
  // å½“åˆ‡æ¢è´§å¸æ—¶ï¼Œè°ƒæ•´é‡‘é¢
  const handleCurrencyChange = (currency) => {
    setTargetCurrency(currency);
    const newMin = currency === 'zeta' ? 10 : 70;
    if (amount < newMin) {
      setAmount(newMin);
    }
  };
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="bg-white w-[min(480px,95vw)] rounded-2xl border shadow-lg p-4">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold text-lg">ğŸ¦ é“¶è¡Œ</div>
          <button onClick={onClose} className="text-slate-500 hover:text-slate-700">âœ–</button>
        </div>
        <div className="text-sm text-slate-600 mb-3">å½“å‰æŒæœ‰é‡‘å¸ï¼š<b>{coins}</b></div>
        <div className="mb-3">
          <div className="text-sm text-slate-700 mb-2">å…‘æ¢ç›®æ ‡ï¼š</div>
          <div className="flex gap-2 mb-2">
            <button 
              onClick={() => handleCurrencyChange('zeta')} 
              className={`px-3 py-2 rounded-lg border flex-1 ${targetCurrency==='zeta'?'bg-emerald-100 border-emerald-300':'bg-white hover:bg-slate-50'}`}
            >
              Î– ZETA
            </button>
            <button 
              onClick={() => handleCurrencyChange('tickets')} 
              className={`px-3 py-2 rounded-lg border flex-1 ${targetCurrency==='tickets'?'bg-emerald-100 border-emerald-300':'bg-white hover:bg-slate-50'}`}
            >
              ğŸŸï¸ å¥–åˆ¸
            </button>
          </div>
        </div>
        <div className="mb-3">
          <div className="text-sm text-slate-700 mb-2">å…‘æ¢é‡‘é¢ï¼ˆé‡‘å¸ï¼‰ï¼š</div>
          <div className="flex items-center gap-2 mb-2">
            <input 
              type="number" 
              min={minAmount} 
              max={coins}
              step={targetCurrency === 'zeta' ? 10 : 70}
              value={validAmount} 
              onChange={(e)=>setAmount(clamp(parseInt(e.target.value||minAmount,10),minAmount,coins))}
              className="flex-1 px-3 py-2 border rounded-lg" 
            />
          </div>
          <div className="flex gap-2 mb-2">
            {targetCurrency === 'zeta' ? (
              <>
                <button onClick={() => setAmount(10)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">10</button>
                <button onClick={() => setAmount(100)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">100</button>
                <button onClick={() => setAmount(1000)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">1000</button>
              </>
            ) : (
              <>
                <button onClick={() => setAmount(70)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">70</button>
                <button onClick={() => setAmount(350)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">350</button>
                <button onClick={() => setAmount(700)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">700</button>
              </>
            )}
            <button onClick={() => setAmount(coins)} className="px-2 py-1 text-xs rounded border bg-white hover:bg-slate-50">å…¨éƒ¨</button>
          </div>
        </div>
        <div className="text-sm text-slate-700 mb-3 p-3 bg-slate-50 rounded-lg">
          <div>{exchangeRate} é‡‘å¸ = 1 {targetCurrency === 'zeta' ? 'ZETA' : 'å¥–åˆ¸'}</div>
          <div className="font-semibold mt-1">
            {validAmount} é‡‘å¸ â†’ {exchangeAmount} {targetCurrency === 'zeta' ? 'ZETA' : 'å¥–åˆ¸'}
          </div>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={()=>{
              if (coins < validAmount) {
                toast("é‡‘å¸ä¸è¶³");
                return;
              }
              if (exchangeAmount < 1) {
                toast(`å…‘æ¢æ•°é‡è‡³å°‘éœ€è¦${minAmount}é‡‘å¸`);
                return;
              }
              onExchange(validAmount, targetCurrency);
              setAmount(minAmount);
            }} 
            className="flex-1 px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50"
            disabled={coins < validAmount || exchangeAmount < 1}
          >
            å…‘æ¢
          </button>
          <button onClick={onClose} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å…³é—­</button>
        </div>
      </div>
    </div>
  );
}

function GluckModal({ open, onClose, onDraw, tickets }) {
  const [count, setCount] = useState(1);
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div className="bg-white w-[min(560px,95vw)] rounded-2xl border shadow-lg p-4">
        <div className="flex items-center justify-between mb-2">
          <div className="font-semibold text-lg">ğŸ° Gluck æŠ½å¥–</div>
          <button onClick={onClose} className="text-slate-500 hover:text-slate-700">âœ–</button>
        </div>
        <div className="text-sm text-slate-600 mb-3">æ¶ˆè€— <b>å¥–åˆ¸</b> è¿›è¡ŒæŠ½å¥–ã€‚æ¯æ¬¡æ¶ˆè€— 1 å¼ ï¼Œå½“å‰æŒæœ‰ï¼š<b>{tickets}</b></div>
        <div className="flex items-center gap-2 mb-3">
          <button onClick={() => setCount(1)} className={`px-3 py-1 rounded-lg border ${count===1?'bg-emerald-100 border-emerald-300':'bg-white hover:bg-slate-50'}`}>å•æŠ½</button>
          <button onClick={() => setCount(10)} className={`px-3 py-1 rounded-lg border ${count===10?'bg-emerald-100 border-emerald-300':'bg-white hover:bg-slate-50'}`}>åè¿</button>
          <input type="number" min={1} value={count} onChange={(e)=>setCount(clamp(parseInt(e.target.value||'1',10),1,999))} className="w-24 px-2 py-1 border rounded-lg" />
        </div>
        <div className="flex gap-2">
          <button onClick={()=>onDraw(count)} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å¼€å§‹æŠ½å¥–</button>
          <button onClick={onClose} className="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">å…³é—­</button>
        </div>
        <div className="text-[11px] text-slate-500 mt-2">

          <div className="space-y-0.5">
          </div>
        </div>
      </div>
    </div>
  );
}

function SettingsPanel({ onReset }) {
  const [open, setOpen] = useState(false);
  return (
    <div className="bg-white/90 backdrop-blur rounded-2xl p-3 border shadow-sm mt-3">
      <div className="flex items-center justify-between">
        <div className="font-semibold">è®¾ç½®</div>
        <button onClick={() => setOpen(!open)} className="text-xs px-2 py-1 rounded-lg border bg-white hover:bg-slate-50">{open ? "æ”¶èµ·" : "å±•å¼€"}</button>
      </div>
      {open && (
        <div className="mt-2 space-y-2">
          <button onClick={onReset} className="text-xs px-2 py-1 rounded-lg border bg-white hover:bg-slate-50">âš ï¸ æ¸…ç©ºå­˜æ¡£ï¼ˆæµ‹è¯•é…ç½®ï¼‰</button>
          <div className="text-[11px] text-slate-500">æœ¬ Demo ä½¿ç”¨ localStorageï¼›ç”Ÿäº§å¯æ›¿æ¢ä¸ºåç«¯å­˜æ¡£ä¸ç¤¾äº¤ç³»ç»Ÿã€‚</div>
        </div>
      )}
    </div>
  );
}

// === åŠ¨æ€ç§‹æ™¯èƒŒæ™¯ ===
function AutumnBackground() {
  // ä½¿ç”¨å†…è” style æ³¨å…¥å…³é”®å¸§ï¼Œé¿å…å¤–éƒ¨ä¾èµ–
  return (
    <div className="absolute inset-0 -z-10 overflow-hidden">
      <style>{`
        @keyframes cloudMove { 0%{transform:translateX(-20%)} 100%{transform:translateX(120%)} }
        @keyframes leafFall { 0%{ transform:translateY(-10%) rotate(0deg); opacity:0 } 10%{opacity:1} 100%{ transform:translateY(120%) rotate(360deg); opacity:0 } }
      `}</style>
      {/* å¤©ç©ºæ¸å˜ */}
      <div className="absolute inset-0 bg-gradient-to-b from-amber-100 via-amber-50 to-emerald-50" />
      {/* è¿œå±±/ç”°é‡è‰²å¸¦ */}
      <div className="absolute bottom-0 left-0 right-0 h-40 bg-gradient-to-t from-amber-200/60 to-transparent" />
      {/* ç§»åŠ¨äº‘å±‚ */}
      <div className="absolute top-10 left-0 right-0 h-20 opacity-60" style={{ animation: 'cloudMove 60s linear infinite' }}>
        <div className="mx-auto max-w-6xl h-full bg-white/40 blur-2xl rounded-full" />
      </div>
      {/* é£˜è½æ ‘å¶ï¼ˆå‡ å±‚ä¸åŒæ—¶é•¿ï¼‰ */}
      {Array.from({length: 12}).map((_,i)=> (
        <div key={i} className="absolute text-2xl" style={{ left: `${Math.random()*100}%`, animation: `leafFall ${20 + Math.random()*15}s linear ${Math.random()*5}s infinite` }}>
          {['ğŸ‚','ğŸ','ğŸƒ'][i%3]}
        </div>
      ))}
    </div>
  );
}

/**********************
 * è½»é‡ Toast ç³»ç»Ÿ     *
 **********************/
const toasts = [];
let toastId = 1;
const listeners = [];
function toast(text) {
  const item = { id: toastId++, text };
  toasts.push(item);
  listeners.forEach((l) => l([...toasts]));
  setTimeout(() => {
    const idx = toasts.findIndex((t) => t.id === item.id);
    if (idx >= 0) { toasts.splice(idx, 1); listeners.forEach((l) => l([...toasts])); }
  }, 2200);
}

function ToastArea() {
  const [, setTick] = useState(0);
  useEffect(() => {
    const l = (list) => setTick(list.length);
    listeners.push(l);
    return () => { const i = listeners.indexOf(l); if (i >= 0) listeners.splice(i, 1); };
  }, []);
  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 space-y-2">
      {toasts.map((t) => (
        <div key={t.id} className="px-3 py-2 rounded-xl bg-slate-900/90 text-white text-sm shadow-lg backdrop-blur">{t.text}</div>
      ))}
    </div>
  );
}

// ====== dev=1ï¼šæµ‹è¯•ï¼ˆä»…æ–°å¢ï¼Œä¸ä¿®æ”¹åŸæœ‰ï¼‰ ======
(function DevTests(){
  if (typeof window === 'undefined') return;
  const isDev = new URLSearchParams(window.location.search).get('dev') === '1';
  if (!isDev) return;
  try {
    const results = [];
    const add = (name, cond, extra="") => { results.push({ name, pass: !!cond, extra }); };
    add('cursorForTool returns string', typeof cursorForTool('plant') === 'string');
    const seed = SEEDS.radish; const t0 = 1000; const plantedAt = t0 - (seed.stages[0]-1);
    const fakePlot = { seedId: 'radish', plantedAt, fertilized:false, weeds:false, pests:false };
    add('yieldAmount >=1', yieldAmount(fakePlot) >= 1);
    console.log('[DEV EXTRA TESTS]', results);
  } catch(e) { console.warn('Dev tests init failed', e); }
})();


      // æŒ‚è½½åº”ç”¨
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<SocialFarmGame />);
    </script>
  </body>
</html>
